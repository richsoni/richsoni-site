{"data":{"markdownRemark":{"html":"<p>This is the fourth pass of converting this site to Typescript.</p>\n<h3>Previous Posts</h3>\n<ul>\n<li><a href=\"/posts/2018-12-10-installing-typescript\">Installing Typescript on RichSoni.com</a></li>\n<li><a href=\"/posts/2018-12-18-naive-typescript-conversion-pass-1\">Typescript Conversion Pass 1</a></li>\n<li><a href=\"/posts/2018-12-19-naive-typescript-conversion-pass-2\">Typescript Conversion Pass 2</a></li>\n<li>[Typescript Conversion Pass 3]</li>\n</ul>\n<h1>Experiment Parameters</h1>\n<ol>\n<li>Convert all javascript files in <code>src/</code> to typescript</li>\n<li>Must include: a post with content from this document</li>\n</ol>\n<h1>Strategy</h1>\n<p>Similarly to [Typescript Conversion Pass 3], I did a simple rename of all <code>js</code> files to <code>ts</code>:</p>\n<pre><code>$ git ls-files -- 'src/*.js'\nsrc/pages/albums.js\nsrc/pages/events.js\nsrc/pages/index.js\nsrc/pages/posts.js\nsrc/pages/songs.js\nsrc/pages/subscribe.js\nsrc/templates/albums.js\nsrc/templates/events.js\nsrc/templates/posts.js\nsrc/templates/songs.js\n\n$ rename -n 's/.js$/.ts/' src/**/*.js\n'src/pages/albums.js' would be renamed to 'src/pages/albums.ts'\n'src/pages/events.js' would be renamed to 'src/pages/events.ts'\n'src/pages/index.js' would be renamed to 'src/pages/index.ts'\n'src/pages/posts.js' would be renamed to 'src/pages/posts.ts'\n'src/pages/songs.js' would be renamed to 'src/pages/songs.ts'\n'src/pages/subscribe.js' would be renamed to 'src/pages/subscribe.ts'\n'src/templates/albums.js' would be renamed to 'src/templates/albums.ts'\n'src/templates/events.js' would be renamed to 'src/templates/events.ts'\n'src/templates/posts.js' would be renamed to 'src/templates/posts.ts'\n'src/templates/songs.js' would be renamed to 'src/templates/songs.ts'\n~/code/personal/richsoni.github.io(master)-------------------------------------rsoni@richsoni 10:13\n</code></pre>\n<h1>Outcome</h1>\n<pre><code>$ ./scripts/typescript-vs-javascript\n100% (47 Typescript / 0 Javascript)\n\n$ cat ./scripts/typescript-vs-javascript\n#!/usr/bin/env ruby\n\njs = `git ls-files src/ | grep -e 'jsx\\\\?$' | wc -l`.to_i\nts = `git ls-files src/ | grep -e 'tsx\\\\?$' | wc -l`.to_i\n\nputs \"#{((ts/((js + ts) * 1.0)).round(2) * 100).to_i}% (#{ts} Typescript / #{js} Javascript)\"\n</code></pre>\n<h2>Summary Of Changes</h2>\n<p>This was the largest set of changes I did throughout this whole project.  It took the longest amount of time by far (I lost track), and there was a lot learned during the process.</p>\n<h3>Typescript Files</h3>\n<p>I converted a total of 18 Typescript files in this commit.  Besides the Gatsby files which are not in Typescript, this is the entirety of my application.</p>\n<pre><code>$ git diff master --stat -- '*.ts*'\n  src/components/Tabs/index.tsx |   2 +-\n  src/data/albums.d.ts          |  25 ++++\n  src/data/events.d.ts          |  29 +++++\n  src/data/graphql.d.ts         |  14 +++\n  src/data/locations.d.ts       |  31 +++++\n  src/data/remark.d.ts          |  39 +++++++\n  src/data/songs.d.ts           |  25 ++++\n  src/pages/albums.tsx          |  63 +++++++++++\n  src/pages/events.tsx          | 120 ++++++++++++++++++++\n  src/pages/index.tsx           |  68 +++++++++++\n  src/pages/posts.tsx           | 180 +++++++++++++++++++++++++++++\n  src/pages/songs.tsx           | 179 +++++++++++++++++++++++++++++\n  src/pages/subscribe.tsx       |  42 +++++++\n  src/templates/albums.tsx      |  90 +++++++++++++++\n  src/templates/events.tsx      | 201 +++++++++++++++++++++++++++++++++\n  src/templates/posts.tsx       |  52 +++++++++\n  src/templates/songs.tsx       |  83 ++++++++++++++\n  src/utils/data.ts             |  17 ++-\n  18 files changed, 1255 insertions(+), 5 deletions(-)\n</code></pre>\n<h3>Gatsby Node</h3>\n<p>I had to alter my <code>gatsby-node</code> file to also look for Typescript file extensions:</p>\n<pre><code>diff --git a/gatsby-node.js b/gatsby-node.js\nindex e258cd8..cc074e4 100644\n--- a/gatsby-node.js\n+++ b/gatsby-node.js\n@@ -54,7 +54,10 @@ exports.createPages = ({ graphql, actions }) => {\n       result.data.allMarkdownRemark.edges.forEach(({ node }) => {\n         const type = node.fields.relativeDirectory;\n         const url = node.fields.url;\n-        const template = path.resolve(`./src/templates/${type}.js`);\n+        let template = path.resolve(`./src/templates/${type}.js`);\n+        if(!existsSync(template)) {\n+          template = path.resolve(`./src/templates/${type}.tsx`);\n+        }\n         if(existsSync(template))\n         {\n           //Create Basic Blog Pages\n</code></pre>\n<h3>SL script</h3>\n<p>I created a Script List (sl) script as well in this project in this branch:</p>\n<pre><code>$ cat scripts/sl\necho '\\n------------------------------------------------\\n'\necho 'SCRIPTS: \\n'\necho \"$ cat package.json | jq -r '.scripts | keys | map(\"yarn \"+.) | join(\"__\")' | sed 's/__/\\'$'\\n/g'\"\ncat package.json | jq -r '.scripts | keys | map(\"yarn \"+.) | join(\"__\")' | sed 's/__/\\'$'\\n/g'\necho '\\n------------------------------------------------\\n'\n\necho '\\n$ tree scripts\\n'\ntree scripts\necho '\\n------------------------------------------------\\n'\n</code></pre>\n<pre><code>$ sl\n\n------------------------------------------------\n\nSCRIPTS:\n\n$ cat package.json | jq -r '.scripts | keys | map(yarn +.) | join(__)' | sed 's/__/\\'$'\n/g'\nyarn build\nyarn deploy\nyarn develop\nyarn serve\nyarn start\nyarn tsc:check\nyarn tsc:coverage\nyarn tsc:watch\n\n------------------------------------------------\n\n\n$ tree scripts\n\nscripts\n├── sl\n├── typescript-vs-javascript\n└── wav-to-aiff.sh\n\n0 directories, 3 files\n\n------------------------------------------------\n</code></pre>\n<h2>Learnings</h2>\n<p>I stepped into this commit confident in my tooling.\nThis allowed me to focus on learning Typescript.\nI looked at each new file as an opportunity to not only make the compiler happy, but to actually implement Typings to the best of my ability.\nThis required a lot of reading, and fiddling with things.</p>\n<p>This pushed me out of my comfort zone, and led me into some really interesting places.</p>\n<h3>Design To Type</h3>\n<p>Converting a file from ESNext to Typescript feels more like adding tests to existing code than changing languages.\nThis is because the architecture decisions which are made when Typings are considered are similar to those made when testing is considered.\nAnd, just like retroactively testing, retroactively typing can get hairy when boundaries between code are ill defined.</p>\n<p>Perhaps the most striking example in my application is the GraphQL interface.</p>\n<p>Gatsby's GraphQL API is the main way data is fed into the UI.\nVarious plugins can be used to provide different data transformations.\nAdditionally, Gatsby directly injects this data, which I passed around willy nilly.</p>\n<p>This becomes problematic when you try to reuse Typings, but GraphQL queries do not match.\nUltimately, I would have architected my application differently if I had considered types from the get go.</p>\n<p>As it stands, I have some generic types defined:</p>\n<pre><code>export interface RemarkFields {\n  basename: string,\n  url: string,\n  date?: string,\n  notdate?: string,\n}\n\nexport interface RemarkNode extends GatsbyNode {\n  frontmatter: RemarkFrontmatter,\n  fields: RemarkFields,\n  html?: string,\n  id: string,\n}\n</code></pre>\n<p>I also have specific types which extend those:</p>\n<pre><code>export interface LocationNode extends RemarkNode {\n  fields: LocationFields,\n  name: string,\n  website: string,\n  address: {\n    region: string,\n    locality: string,\n    country: string,\n  }\n}\n</code></pre>\n<h3>GraphQL Generator is weird</h3>\n<p>I found this: <a href=\"https://www.camdub.io/2018/04/20/generating-typescript-types-gatsbyjs-graphql-schema/\">https://www.camdub.io/2018/04/20/generating-typescript-types-gatsbyjs-graphql-schema/</a>\nWhich notes that you can automate GraphQL type definition.</p>\n<p>I found it confusing and verbose.  And, was happy enough with my hand crafted types, so I abandonded this library.</p>\n<h3>Types VS Interfaces</h3>\n<p>It took me awhile to track down the n00b version of this answer:\nUse interfaces until further noted, and interfaces can be extended.</p>\n<p><a href=\"https://stackoverflow.com/questions/37233735/typescript-interfaces-vs-types\">https://stackoverflow.com/questions/37233735/typescript-interfaces-vs-types</a>\n<a href=\"https://www.typescriptlang.org/docs/handbook/interfaces.html\">https://www.typescriptlang.org/docs/handbook/interfaces.html</a></p>\n<h3>Casting Types</h3>\n<p>One of the things that took me a while to figure out was the proper way to cast types.</p>\n<p>Here is my cheat sheet on Typings:</p>\n<pre><code>type User { active: boolean }\ninterface Admin extends User { roles: object }\nconst firstActiveUser = (users: User[]): User { users.find((u) => u.active) }\nconst firstActiveAdmin: Admin = firstActiveUser(admins) as Admin\n</code></pre>\n<h1>Conclusion</h1>\n<p>This was a great exercise to see a wider swath of use cases in Typescript.\nAfter this exercise I feel compitent enough to architect new features in Typescript.</p>\n<p>I also completed the work for my Typescript conversion project in this exercise.</p>","frontmatter":{"title":"Naive Typescript Conversion on RichSoni.com: Pass 4","hero":"/images/posts/gatsby-logo.jpg"},"fields":{"date":"2019-01-08"}}},"pageContext":{"url":"/posts/2019-01-08-naive-typescript-conversion-pass-4/"}}